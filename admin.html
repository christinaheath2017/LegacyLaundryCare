<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #fff;
      color: #333;
    }
    h2 {
      margin-bottom: 20px;
    }
    .booking-entry {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    .legacy {
      border-left: 5px solid gold;
      background-color: #fffbe6;
    }
    .express {
      border-left: 5px solid crimson;
      background-color: #ffecec;
    }
    .tier-badge {
      display: inline-block;
      padding: 3px 8px;
      margin-top: 5px;
      font-size: 0.85em;
      background-color: #eee;
      border-radius: 4px;
    }
    .tier-badge.legacy {
      background-color: gold;
      color: #333;
      font-weight: bold;
    }
    .tier-badge.express {
      background-color: crimson;
      color: #fff;
      font-weight: bold;
    }
    select, textarea {
      margin-top: 5px;
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    label {
      margin-top: 10px;
      display: block;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Admin Dashboard – All Bookings</h2>
  <div id="adminBookings">Loading bookings...</div>

  <script>
    const supabase = supabase.createClient(
      'https://ztcyemsqljopyjbzpqvq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0Y3llbXNxbGpvcHlqYnpwcXZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDg5ODYsImV4cCI6MjA3MzEyNDk4Nn0.WN4AQxfSWUtuVdACmkSe5O13nuxkp8-6On0RAmDJrro'
    );

    async function loadAllBookings() {
      const { data: bookings, error } = await supabase
        .from("bookings")
        .select("*")
        .order("created_at", { ascending: false });

      if (error || !bookings.length) {
        document.getElementById("adminBookings").innerHTML = "<p>No bookings found.</p>";
        return;
      }

      const html = bookings.map(b => {
        const isLegacy = b.name === "Miss Judy";
        const isExpress = b.service === "Express";
        const tierLabel = isLegacy ? "Legacy Care Client" : "Standard Client";
        const tierClass = isLegacy ? "legacy" : "";
        const urgencyClass = isExpress ? "express" : "";
        const addOns = b.add_ons ? Object.values(b.add_ons).filter(v => v !== "None").join(", ") : "None";

        return `
          <div class="booking-entry ${tierClass} ${urgencyClass}">
            <strong>${b.service}</strong> – ${b.bag_count || 0} bags (${b.bag_size || "Standard"})<br>
            <strong>Client:</strong> ${b.name || "Unknown"} (${b.email || "—"})<br>
            <span class="tier-badge ${tierClass}">${tierLabel}</span>
            ${isExpress ? '<span class="tier-badge express">Express Load</span>' : ''}<br>
            Add-ons: ${addOns}<br>
            Estimated Cost: $${b.amount_estimate || "0.00"}<br>
            Stripe Intent ID: ${b.stripe_intent_id || "Not created"}<br>
            Payment Status: ${b.status || "Pending"}<br>
            <p><strong>Client Message:</strong><br>${b.notes || "—"}</p>

            <label>Internal Notes:</label>
            <textarea onchange="saveInternalNote('${b.id}', this.value)" placeholder="e.g. guest arriving tomorrow">${b.internal_note || ""}</textarea>

            <label>Status:</label>
            <select onchange="updateStatus('${b.id}', this.value)">
              <option value="Pending" ${b.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Held" ${b.status === "Held" ? "selected" : ""}>Held</option>
              <option value="Captured" ${b.status === "Captured" ? "selected" : ""}>Captured</option>
              <option value="Completed" ${b.status === "Completed" ? "selected" : ""}>Completed</option>
              <option value="Canceled" ${b.status === "Canceled" ? "selected" : ""}>Canceled</option>
            </select><br>
            Date: ${new Date(b.created_at).toLocaleString()}
          </div>
        `;
      }).join("");

      document.getElementById("adminBookings").innerHTML = html;
    }

    async function updateStatus(bookingId, newStatus) {
      const { error } = await supabase
        .from("bookings")
        .update({ status: newStatus })
        .eq("id", bookingId);

      if (error) {
        alert("Failed to update status: " + error.message);
      } else {
        loadAllBookings();
      }
    }

    async function saveInternalNote(bookingId, note) {
      const { error } = await supabase
        .from("bookings")
        .update({ internal_note: note })
        .eq("id", bookingId);

      if (error) {
        alert("Failed to save note: " + error.message);
      }
    }

    loadAllBookings();
  </script>
</body>
</html>
