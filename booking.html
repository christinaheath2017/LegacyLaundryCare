<!DOCTYPE html>
<html>
<head>
  <title>Legacy Laundry Booking</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #fefefe;
      color: #333;
    }
    h2 {
      margin-bottom: 20px;
    }
    form {
      border: 1px solid #ccc;
      padding: 20px;
      background-color: #f9f9f9;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    #receiptText {
      margin-top: 15px;
      background: #eee;
      padding: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Book Your Laundry Pickup</h2>
  <form id="bookingForm" action="https://formspree.io/f/YOUR_FORM_ID" method="POST">
    <label for="tier">Service Tier:</label>
    <select id="tier" name="tier" required>
      <option value="Standard">Standard</option>
      <option value="Express">Express</option>
    </select>

    <label for="bagSize">Bag Size:</label>
    <select id="bagSize" name="bagSize" required>
      <option value="Small">Small (20 lbs)</option>
      <option value="Medium">Medium (50 lbs)</option>
      <option value="Large">Large (75 lbs)</option>
    </select>

    <label for="bagCount">Number of Bags:</label>
    <input type="number" id="bagCount" name="bagCount" min="1" required>

    <label for="detergent">Detergent:</label>
    <select id="detergent" name="detergent">
      <option value="None">None</option>
      <option value="Tide">Tide</option>
      <option value="Gain">Gain</option>
      <option value="Persil">Persil</option>
      <option value="All">All Free & Clear</option>
    </select>

    <label for="softener">Softener:</label>
    <select id="softener" name="softener">
      <option value="None">None</option>
      <option value="Downy">Downy</option>
      <option value="Gain">Gain</option>
      <option value="TideFree">Tide Free & Gentle</option>
      <option value="All">All Free & Clear</option>
    </select>

    <label for="dryerSheets">Dryer Sheets:</label>
    <select id="dryerSheets" name="dryerSheets">
      <option value="None">None</option>
      <option value="Bounce">Bounce</option>
      <option value="Gain">Gain</option>
      <option value="Snuggle">Snuggle</option>
    </select>

    <label for="scentBoosters">Scent Boosters:</label>
    <select id="scentBoosters" name="scentBoosters">
      <option value="None">None</option>
      <option value="Unstoppables">Unstoppables</option>
      <option value="GainFireworks">Gain Fireworks</option>
      <option value="ArmHammer">Arm & Hammer</option>
    </select>

    <label for="extras">Extras:</label>
    <select id="extras" name="extras">
      <option value="None">None</option>
      <option value="StainTreatment">Stain Treatment</option>
      <option value="Whitening">Whitening Boost</option>
      <option value="RustRemoval">Rust Removal</option>
    </select>

    <label for="clientMessage">Message or Notes:</label>
    <textarea id="clientMessage" name="clientMessage" rows="4" placeholder="Optional notes for your laundry care..."></textarea>

    <input type="hidden" id="estimatedCost" name="estimatedCost">
    <div id="receiptText">Estimated total will appear here.</div>

    <button type="submit">Submit Booking</button>
  </form>

  <script>
    const supabase = supabase.createClient(
      'https://ztcyemsqljopyjbzpqvq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0Y3llbXNxbGpvcHlqYnpwcXZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDg5ODYsImV4cCI6MjA3MzEyNDk4Nn0.WN4AQxfSWUtuVdACmkSe5O13nuxkp8-6On0RAmDJrro'
    );

    function calculateTotal() {
      const tier = document.getElementById("tier").value;
      const bagSize = document.getElementById("bagSize").value;
      const bagCount = parseInt(document.getElementById("bagCount").value) || 0;

      const weightMap = {
        Small: 20,
        Medium: 50,
        Large: 75
      };

      const weight = weightMap[bagSize] * bagCount;
      const rate = tier === "Express" ? 3.5 : 2.5;
      const subtotal = weight * rate;
      const minimum = tier === "Express" ? 45 : 30;
      const total = Math.max(subtotal, minimum);

      const receipt = `Estimated Total: $${total.toFixed(2)}\n\nDetails:\nTier: ${tier}\nBag Size: ${bagSize}\nBags: ${bagCount}\nWeight: ${weight} lbs\nRate: $${rate.toFixed(2)}/lb`;
      document.getElementById("receiptText").textContent = receipt;
      document.getElementById("estimatedCost").value = `$${total.toFixed(2)}`;
    }

    document.getElementById("tier").addEventListener("change", calculateTotal);
    document.getElementById("bagSize").addEventListener("change", calculateTotal);
    document.getElementById("bagCount").addEventListener("input", calculateTotal);

    document.getElementById("bookingForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) {
        alert("Please log in before submitting a booking.");
        return;
      }

      const bookingData = {
        user_id: user.id,
        tier: document.getElementById("tier").value,
        bag_size: document.getElementById("bagSize").value,
        bag_count: parseInt(document.getElementById("bagCount").value),
        add_ons: {
          detergent: document.getElementById("detergent").value,
          softener: document.getElementById("softener").value,
          dryerSheets: document.getElementById("dryerSheets").value,
          scentBoosters: document.getElementById("scentBoosters").value,
          extras: document.getElementById("extras").value
        },
        estimated_cost: document.getElementById("estimatedCost").value,
        client_message: document.getElementById("clientMessage").value,
        status: "Pending"
      };

      const { error } = await supabase.from("bookings").insert([bookingData]);
      if (error) {
        alert("Booking failed: " + error.message);
      } else {
        alert("Booking submitted successfully!");
        e.target.submit(); // continue to Formspree redirect
      }
    });
  </script>
</body>
</html>
